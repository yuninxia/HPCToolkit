# SPDX-FileCopyrightText: Contributors to the HPCToolkit Project
#
# SPDX-License-Identifier: BSD-3-Clause

spack:
  view: false
  concretizer:
    unify: false
    reuse:
      roots: false
      exclude:
      - hpctoolkit
      from:
      - type: external
      - type: buildcache
    targets:
      granularity: generic
    duplicates:
      strategy: minimal

  definitions:
  - hpct_cuda: [+cuda]
  - when: env.get("ENV_ONLY_CUDA", "0") == "0"
    hpct_cuda: [~cuda]

  specs:
  - matrix:
    - [hpctoolkit build_system=meson buildtype=release ~viewer ~mpi]
    - [+papi, ~papi]
    - [$hpct_cuda]
    # FIXME: Figure out how to select an appropriate OpenCL implementation for +opencl
    - [~opencl]
    exclude:
    - hpctoolkit +papi +cuda

  packages:
    all:
      require:
      - target=:x86_64_v3
      - '%gcc'

    # Pin variants to avoid excessively large builds and improve concretization speed
    papi:
      require:
      - '+shared ~cuda ~infiniband ~lmsensors ~nvml ~powercap ~rapl ~rocm ~rocm_smi ~sde ~static_tools'
      - target=:x86_64_v3
      - '%gcc'
    hwloc:
      require:
      - '~cairo ~cuda ~gl ~libudev ~netloc ~nvml ~level_zero ~opencl ~rocm'
      - target=:x86_64_v3
      - '%gcc'

  mirrors:
    spack-develop:
      url: https://binaries.spack.io/develop
      signed: true
      binary: true
      source: false

    hpctoolkit-ci:
      url: oci://registry.gitlab.com/hpctoolkit/hpctoolkit/ci.spack-buildcache
      signed: false
      binary: true
      source: false
